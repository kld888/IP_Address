<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>照片上傳與記錄</title>
</head>
<body>
  <h1>照片上傳與記錄</h1>
  <p id="ipInfo">載入中...</p>
  <button id="capturePhoto">拍攝照片並上傳</button>
  <p id="status">尚未開始操作</p>

  <script>
    // 獲取 IP 資訊
    fetch('https://api.ipify.org?format=json')
      .then(res => res.json())
      .then(data => {
        document.getElementById('ipInfo').innerText = `IP: ${data.ip}`;
        window.ipInfo = data.ip; // 保存 IP 信息
      })
      .catch(error => {
        document.getElementById('ipInfo').innerText = '無法獲取 IP 資訊';
        console.error(error);
      });

    // 拍攝照片並上傳
    document.getElementById('capturePhoto').addEventListener('click', async () => {
      const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
      const videoTrack = videoStream.getVideoTracks()[0];
      const imageCapture = new ImageCapture(videoTrack);
      const photoBlob = await imageCapture.takePhoto();

      const reader = new FileReader();
      reader.onloadend = () => {
        const base64Photo = reader.result; // 照片的 Base64 資料

        // 發送數據到 Google Apps Script
        fetch('https://script.google.com/macros/s/AKfycbw.../exec', { // 替換為您的 Apps Script URL
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ip: window.ipInfo,
            photoDataUrl: base64Photo,
            userAgent: navigator.userAgent,
            city: '未知',
            region: '未知',
            country: '未知',
            org: '未知',
            ipType: 'IPV4',
          }),
        })
          .then(res => res.json())
          .then(data => {
            document.getElementById('status').innerText = '上傳成功！照片 URL: ' + data.photoUrl;
          })
          .catch(error => {
            document.getElementById('status').innerText = '上傳失敗，請檢查控制台日誌。';
            console.error(error);
          });
      };
      reader.readAsDataURL(photoBlob);
    });
  </script>
</body>
</html>
